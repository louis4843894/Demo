<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>登入 · 社區客服系統</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0a443f" />
  <link rel="manifest" href="manifest.webmanifest" />
  <link rel="icon" href="icons/icon-192.png" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />

  <!-- Material Web -->
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:FILL@0..1" rel="stylesheet" />
  <script type="module">import 'https://esm.run/@material/web/all.js';</script>

  <style>
    html,body{height:100%}
    body{margin:0;font-family: Roboto, system-ui, -apple-system, "Segoe UI", Arial; background:#f6f7fb; display:grid; place-items:center}
    .card{background:#fff; width:min(720px, calc(100vw - 24px)); border-radius:18px; box-shadow:0 16px 48px rgba(0,0,0,.1); padding:22px}
    .muted{opacity:.66}
    .row{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    form{display:block}
    .err{color:#b00020;margin-top:8px;display:none}
    .banner{display:flex;align-items:center;gap:10px;background:#eaf1ef;color:#0a443f;padding:10px 12px;border-radius:12px;margin:6px 0 14px}
  </style>
</head>
<body>
  <div class="card">
    <h2 style="margin:0 0 4px; font-weight:900; letter-spacing:.3px">登入系統</h2>
    <div class="muted" style="margin-bottom:8px">選擇身分登入：住戶、管委會、廠商。</div>

    <div id="signedBanner" class="banner" style="display:none">
      <span class="material-symbols-outlined">verified_user</span>
      <div>
        <div id="signedText">你目前已登入。</div>
        <div class="muted" id="nextInfo" style="margin-top:2px"></div>
      </div>
      <div style="margin-left:auto;display:flex;gap:8px">
        <md-filled-tonal-button id="btnGo">直接前往</md-filled-tonal-button>
        <md-outlined-button id="btnSignOut">登出</md-outlined-button>
      </div>
    </div>

    <form id="loginForm">
      <div class="row">
        <md-outlined-text-field id="email" label="Email*" value="test@example.com" style="flex:1 1 280px" required></md-outlined-text-field>
        <md-outlined-text-field id="password" label="密碼*" type="password" value="123456" style="flex:1 1 200px" required></md-outlined-text-field>
      </div>

      <div style="margin:10px 0 6px">身分</div>
      <div class="row" role="radiogroup" aria-label="身分">
        <md-filter-chip id="role_resident" selected>住戶</md-filter-chip>
        <md-filter-chip id="role_committee">管委會</md-filter-chip>
        <md-filter-chip id="role_vendor">廠商</md-filter-chip>
      </div>

      <div class="row" style="margin-top:16px">
        <md-filled-button id="btnLogin" type="submit">
          <span class="material-symbols-outlined" slot="icon">login</span>登入 / 變更身分
        </md-filled-button>
        <md-outlined-button type="button" onclick="location.href='index.html'">
          <span class="material-symbols-outlined" slot="icon">home</span>回首頁
        </md-outlined-button>
      </div>
      <div class="err" id="errMsg"></div>
    </form>
  </div>

  <script src="index.js"></script>
  <script>
    // next 僅允許相對路徑（用 index.js 的 toRelative）
    const params  = new URLSearchParams(location.search);
    const rawNext = params.get('next') || '';
    const next    = rawNext ? toRelative(rawNext) : ''; // 關鍵

    // 已登入不自動導走；顯示 Banner
    const banner   = document.getElementById('signedBanner');
    const signedTx = document.getElementById('signedText');
    const nextInfo = document.getElementById('nextInfo');
    const btnGo    = document.getElementById('btnGo');
    const btnOut   = document.getElementById('btnSignOut');

    if (isLoggedIn()) {
      const map = { resident:'住戶', committee:'管委會', vendor:'廠商', guest:'訪客' };
      signedTx.textContent = `你目前以「${map[getRole()]||'訪客'}」身分登入：${getUser()?.email||''}`;
      nextInfo.textContent = next ? `目的頁：${next}` : '未指定目的頁，登入後將依身分自動帶位';
      banner.style.display = '';
      btnGo.addEventListener('click', ()=> redirectAfterLogin(next, getRole()));
      btnOut.addEventListener('click', ()=> { clearUser(); location.reload(); });
    }

    // 單選 chips
    const chips = {
      resident:  document.getElementById('role_resident'),
      committee: document.getElementById('role_committee'),
      vendor:    document.getElementById('role_vendor'),
    };
    Object.entries(chips).forEach(([k, chip])=>{
      chip.addEventListener('click', ()=>{
        Object.values(chips).forEach(c=>c.selected=false);
        chip.selected = true;
      });
    });

    // 表單送出
    const form = document.getElementById('loginForm');
    const err  = document.getElementById('errMsg');
    form.addEventListener('submit', (e)=>{
      e.preventDefault();
      err.style.display = 'none'; err.textContent = '';

      const email = document.getElementById('email').value.trim();
      const pwd   = document.getElementById('password').value;
      const role  = chips.committee.selected ? 'committee' : (chips.vendor.selected ? 'vendor' : 'resident');

      if (!email) { err.textContent = '請輸入 Email'; err.style.display='block'; return; }
      if (!pwd)   { err.textContent = '請輸入密碼'; err.style.display='block'; return; }

      setUser({ email, name: email.split('@')[0], role, lastLoginAt: new Date().toISOString() });
      redirectAfterLogin(next, role);
    });
  </script>
</body>
</html>
